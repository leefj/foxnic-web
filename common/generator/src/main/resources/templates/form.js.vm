#(authorAndTime)

function FormPage() {

	var settings,admin,form,table,layer,util,fox,upload,xmSelect;
	const moduleURL="#(moduleURL)";
	
	/**
      * 入口函数，初始化
      */
	this.init=function(layui) { 	
     	admin = layui.admin,settings = layui.settings,form = layui.form,upload = layui.upload;
		table = layui.table,layer = layui.layer,util = layui.util,fox = layui.foxnic,xmSelect = layui.xmSelect;
		
		//渲染表单组件
		renderFormFields();
		
		//填充表单数据
		fillFormData();
		
		//绑定提交事件
		bindButtonEvent();
		
		//调整窗口的高度与位置
		adjustPopup();
		
	}
	
	function adjustPopup() {
		setTimeout(function () {
			var body=$("body");
			var bodyHeight=body.height();
			var area=admin.changePopupArea(null,bodyHeight);
			admin.putTempData('#(formAreaKey)', area);
		},50);
	}
	
	/**
      * 渲染表单组件
      */
	function renderFormFields() {
		form.render();
	   
	    #for(f : fields)
	    #if(f.isImageField) 
	    //渲染图片字段
	    fox.renderFormUpload({
			el:"#(f.varName)",
			upload:function (result,index,upload) {
				console.log("文件上传后回调")
			},
			remove:function (fileId,index,upload) {
				console.log("文件删除后回调")
			}
	    });
		#else if(f.isSelectField)
		//渲染下拉字段
		fox.renderSelectBox({
			el: "#(f.varName)",
			radio: #(!f.selectField.muliti),
			filterable: true,
			toolbar: {show:true,showIcon:true,list:[ "ALL", "CLEAR","REVERSE"]},
			//转换数据
			#if(f.selectField.enumTypeName!=null)
			transform:function(data) {
				//要求格式 :[{name: '水果', value: 1},{name: '蔬菜', value: 2}]
				var opts=[];
				if(!data) return opts;
				for (var i = 0; i < data.length; i++) {
					opts.push({name:data[i].text,value:data[i].code});
				}
				return opts;
			}
			#end
			#if(f.selectField.queryApi!=null)
			searchField: "name", //请自行调整用于搜索的字段名称
			extraParam: {}, //额外的查询参数，Object 或是 返回 Object 的函数
			transform: function(data) {
				//要求格式 :[{name: '水果', value: 1},{name: '蔬菜', value: 2}]
				var opts=[];
				if(!data) return opts;
				for (var i = 0; i < data.length; i++) {
					//请自行调整此处字段的对应关系
					opts.push({name:data[i].name,value:data[i].id});
				}
				return opts;
			}
			#end
			#if(f.selectField.dictCode!=null)
			transform: function(data) {
				//要求格式 :[{name: '水果', value: 1},{name: '蔬菜', value: 2}]
				var opts=[];
				for (var i = 0; i < data.length; i++) {
					opts.push({name:data[i].text,value:data[i].code});
				}
				return opts;
			}
			#end
		});
	    #end
	    #end
	}
	
	/**
      * 填充表单数据
      */
	function fillFormData() {
		var formData = admin.getTempData('#(formDataKey)');
		var fm=$('#data-form');
		if (formData) {
			fm[0].reset();
			form.val('data-form', formData);

	     	#for(f : fields)
		    #if(f.isImageField)
			//设置  #(f.label)  显示图片
		    if($("##(f.varName)").val()) {
		    	$("##(f.varName)-image").attr("src","/service-storage/sys-file/download?id="+$("##(f.varName)").val());
		    }
		    #end
		    #end

			#for(f : fields)
			#if(f.isSelectField)
			//设置 #(f.label) 下拉框选中值
			if (formData.#(f.selectField.fillBy))	{
				var #(f.varName)Select=xmSelect.get("##(f.varName)",true)
				var #(f.varName)Opionts=#(f.varName)Select.options.transform(formData.#(f.selectField.fillBy));
				#(f.varName)Select.setValue(#(f.varName)Opionts);
			}
			#end
			#end

	     	fm.attr('method', 'POST');
	     	renderFormFields();
		}
		
		//渐显效果
		fm.css("opacity","0.0");
        fm.css("display","");
        setTimeout(function (){
            fm.animate({
                opacity:'1.0'
            },100);
        },1);
        
	}
	
	/**
      * 保存数据，表单提交事件
      */
    function bindButtonEvent() {
    
	    form.on('submit(submit-button)', function (data) {
	    	//debugger;
	    	

	    	#for(f : fields)
		    #if(f.isLogicField)
			//处理 #(f.label) 默认值
		    if(!data.field.#(f.varName)) data.field.#(f.varName)=0;
		    #end
		    #end


			#for(f : fields)
			#if(f.isSelectField)
			//获取 #(f.label) 下拉框的值
			data.field["#(f.varName)"]=xmSelect.get("##(f.varName)",true).getValue("value");
			#end
			#end

	    	var api=moduleURL+"/"+(data.field.#(idPropertyName)?"update":"insert");
	        var task=setTimeout(function(){layer.load(2);},1000);
	        admin.request(api, data.field, function (data) {
	            clearTimeout(task);
			    layer.closeAll('loading');
	            if (data.success) {
	                layer.msg(data.message, {icon: 1, time: 500});
	                admin.finishPopupCenter();
	            } else {
	                layer.msg(data.message, {icon: 2, time: 500});
	            }
	        }, "POST");
	        
	        return false;
	    });
	    
	    //关闭窗口
	    $("#cancel-button").click(function(){admin.closePopupCenter();});
	    
    }

}

layui.config({
	dir: layuiPath,
	base: '/module/'
}).extend({
	xmSelect: 'xm-select/xm-select'
}).use(['form', 'table', 'util', 'settings', 'admin', 'upload','foxnic','xmSelect'],function() {
	(new FormPage()).init(layui);
});